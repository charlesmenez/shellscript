#!/bin/sh
# Dwm Auto Install Script (improved)

set -eu

cat << "EOF"
                                                              
                                                       ____   
                    ,---,               .---.        ,'  , `. 
                  .'  .' `\            /. ./|     ,-+-,.' _ | 
                ,---.'     \       .--'.  ' ;  ,-+-. ;   , || 
                |   |  .`\  |     /__./ \ : | ,--.'|'   |  ;| 
                :   : |  '  | .--'.  '   \' .|   |  ,', |  ': 
                |   ' '  ;  :/___/ \ |    ' '|   | /  | |  || 
                '   | ;  .  |;   \  \;      :'   | :  | :  |, 
                |   | :  |  ' \   ;  `      |;   . |  ; |--'  
                '   : | /  ;   .   \    .\  ;|   : |  | ,     
                |   | '` ,/     \   \   ' \ ||   : '  |/      
                ;   :  .'        :   '  |--" ;   | |`-'       
                |   ,.'           \   \ ;    |   ;/           
                '---'              '---"     '---'            

                         Dwm Auto Install Script
EOF

log() { printf '%s\n' "[$(date +%H:%M:%S)] $*"; }

# Determine root wrapper (sudo/doas) or none if already root
SUDO=""
if [ "$(id -u)" -ne 0 ]; then
  if command -v sudo >/dev/null 2>&1; then
    SUDO="sudo"
  elif command -v doas >/dev/null 2>&1; then
    SUDO="doas"
  else
    log "This script needs root privileges to install system files. Install sudo or doas, or re-run as root."
    exit 1
  fi
fi

sleep 1
log "Checking and installing needed packages"

# Detect package manager
PM=""
for pm in pacman emerge xbps-install; do
  if command -v "$pm" >/dev/null 2>&1; then
    PM="$pm"
    break
  fi
done

if [ -z "$PM" ]; then
  log "No supported package manager found (supported: pacman, emerge, xbps-install). Skipping package installation."
else
  case "$PM" in
    pacman)
      # Update and install packages (non-interactive, only if needed)
      $SUDO pacman -Sy --noconfirm --needed \
        libxft ttf-sourcecodepro-nerd ttf-iosevka-nerd \
        meson ninja acpi uthash noto-fonts-emoji git feh picom imagemagick \
        python-pipx curl openssh yt-dlp ranger zip
      ;;
    emerge)
      # Keep interactive as per Gentoo workflows
      $SUDO emerge --ask \
        dev-vcs/git net-misc/openssh app-arch/zip media-gfx/imagemagick \
        media-gfx/feh x11-misc/picom sys-power/acpi dev-libs/uthash \
        dev-util/meson dev-util/ninja media-fonts/noto-emoji net-misc/yt-dlp \
        app-misc/ranger
      ;;
    xbps-install)
      # Void Linux - sync and install build/runtime deps
      $SUDO xbps-install -Sy \
        git curl feh picom ImageMagick xrdb python3-pipx \
        libXinerama-devel fontconfig-devel libXft-devel harfbuzz-devel \
        make gcc pkg-config ninja noto-fonts-emoji font-iosevka \
        openssh yt-dlp ranger zip
      ;;
  esac
fi

sleep 1
log "Ensuring required directories exist"
mkdir -p "$HOME/sourcecode" "$HOME/.local/bin" "$HOME/.config/picom"

clone_or_update() {
  repo="$1"
  dest="$2"
  if [ -d "$dest/.git" ]; then
    log "Updating $(basename "$dest")"
    git -C "$dest" pull --ff-only
  elif [ -e "$dest" ]; then
    log "Skipping $dest (exists but not a git repository)"
  else
    log "Cloning $(basename "$dest")"
    git clone "$repo" "$dest"
  fi
}

log "Clone or update repositories"
# picom build from source (install to system)
clone_or_update https://github.com/yshui/picom "$HOME/sourcecode/picom"
(
  cd "$HOME/sourcecode/picom"
  meson setup --buildtype=release build 2>/dev/null || true
  ninja -C build
  $SUDO ninja -C build install
)

clone_or_update https://github.com/charlesmenez/Wallpapers "$HOME/Wallpapers"
clone_or_update https://github.com/guillaumeboehm/wal-telegram "$HOME/sourcecode/wal-telegram"
$SUDO make -C "$HOME/sourcecode/wal-telegram" install
clone_or_update https://github.com/charlesmenez/shellscript "$HOME/sourcecode/shellscript"
clone_or_update https://github.com/charlesmenez/dwm "$HOME/sourcecode/dwm"
clone_or_update https://github.com/charlesmenez/dwmblocks "$HOME/sourcecode/dwmblocks"
clone_or_update https://github.com/charlesmenez/dmenu "$HOME/sourcecode/dmenu"
clone_or_update https://github.com/charlesmenez/st "$HOME/sourcecode/st"

log "Installing helper scripts and symlinks"
# Ensure /usr/local/bin exists
$SUDO install -d -m 755 /usr/local/bin

# dwnblocks helper scripts
$SUDO cp -f "$HOME/sourcecode/dwmblocks/scripts/"* /usr/local/bin/

# Symlinks to this repo's helpers
$SUDO ln -sf "$HOME/sourcecode/shellscript/bookmarks" /usr/local/bin/bookmarks
ln -snf "$HOME/sourcecode/shellscript/share/bookmarks" "$HOME/bookmarks"
$SUDO ln -sf "$HOME/sourcecode/shellscript/dmenu-emoji" /usr/local/bin/dmenu-emoji
ln -snf "$HOME/sourcecode/shellscript/share/emoji" "$HOME/emoji"

# Pull remote scripts
$SUDO curl -fsSL https://raw.githubusercontent.com/charlesmenez/shellscript/main/dwm-colors -o /usr/local/bin/dwm-colors
$SUDO curl -fsSL https://raw.githubusercontent.com/charlesmenez/shellscript/main/sysact -o /usr/local/bin/sysact
$SUDO chmod +x /usr/local/bin/dwm-colors /usr/local/bin/sysact

# yt-dlp config
$SUDO curl -fsSL https://raw.githubusercontent.com/charlesmenez/dotfiles/main/yt-dlp/yt-dlp.conf -o /etc/yt-dlp.conf

# picom config
curl -fsSL https://raw.githubusercontent.com/charlesmenez/dotfiles/main/picom/picom.conf -o "$HOME/.config/picom/picom.conf"


# Make wal available system-wide when installed for the user
if [ -x "$HOME/.local/bin/wal" ]; then
  $SUDO ln -sf "$HOME/.local/bin/wal" /usr/local/bin/wal
fi

log "Configuring Xresources and xinitrc"
[ -f "$HOME/.Xresources" ] || touch "$HOME/.Xresources"
# Backup existing .xinitrc if present, then fetch a fresh one
if [ -f "$HOME/.xinitrc" ]; then
  cp "$HOME/.xinitrc" "$HOME/.xinitrc.bak.$(date +%s)"
fi
curl -fsSL https://raw.githubusercontent.com/charlesmenez/dotfiles/main/xinitrc -o "$HOME/.xinitrc"

# Seed colors using wal if wallpaper exists
if [ -x "$HOME/.local/bin/wal" ] && [ -f "$HOME/Wallpapers/minimal.png" ]; then
  "$HOME/.local/bin/wal" -i "$HOME/Wallpapers/minimal.png"
fi
if [ -f "$HOME/.cache/wal/colors.Xresources" ]; then
  cat "$HOME/.cache/wal/colors.Xresources" >> "$HOME/.Xresources"
fi

log "Building and installing dwm suite"
$SUDO make -C "$HOME/sourcecode/st" install
$SUDO make -C "$HOME/sourcecode/dwmblocks" install
$SUDO make -C "$HOME/sourcecode/dwm" install
$SUDO make -C "$HOME/sourcecode/dmenu" install

log "All done. You can now start dwm from your display manager or via startx."
